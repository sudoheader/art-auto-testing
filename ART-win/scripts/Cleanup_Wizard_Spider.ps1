# AtomicRedTeam Wizard Spider Cleanup ...

# Credits to https://github.com/redcanaryco/atomic-red-team and @anantkaul
# Created by @sudoheader
# """"""""""""""""""""""""""""""""""""""""
# !!!!! WARNING: RUN ON WINDOWS ONLY !!!!!
# """"""""""""""""""""""""""""""""""""""""

$res_loc = "C:\AtomicRedTeam\VTF"

Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope CurrentUser -Force
Remove-Item $env:TEMP\svchost-exe.dmp -ErrorAction Ignore

if (-NOT ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
   $arguments = "& '" +$myinvocation.mycommand.definition + "'"
   Start-Process powershell -Verb runAs -ArgumentList $arguments
   Break
} 

function green {
   process { Write-Host $_ -ForegroundColor Green }
}
function yellow {
   process { Write-Host $_ -ForegroundColor Yellow }
}

$date_time = Get-Date -Format "MM:dd:yyyy_HH:mm"
$date_time = $date_time.Replace(':', "-")
cls

$wizard_spider = @(('T1133', 1),
            ('T1566.001', 1),
            ('T1566.001', 2),
            ('T1059.001', 1),
            ('T1059.001', 2),
            ('T1059.001', 3),
            ('T1059.001', 4),
            ('T1059.001', 5),
            ('T1059.001', 6),
            ('T1059.001', 7),
            ('T1059.001', 8),
            ('T1059.001', 9),
            ('T1059.001', 11),
            ('T1059.001', 12),
            ('T1059.001', 13),
            ('T1059.001', 14),
            ('T1059.001', 15),
            ('T1059.001', 16),
            ('T1059.001', 17),
            ('T1059.001', 18),
            ('T1059.001', 19),
            ('T1059.001', 20),
            ('T1059.001', 21),
            ('T1059.003', 1),
            ('T1059.003', 2),
            ('T1059.003', 3),
            ('T1059.003', 4),
            ('T1053.005', 1),
            ('T1053.005', 2),
            ('T1053.005', 3),
            ('T1053.005', 4),
            ('T1053.005', 5),
            ('T1053.005', 6),
            ('T1053.005', 7),
            ('T1569.002', 1),
            ('T1569.002', 2),
            ('T1204.002', 1),
            ('T1204.002', 2),
            ('T1204.002', 3),
            ('T1204.002', 4),
            ('T1204.002', 5),
            ('T1204.002', 6),
            ('T1204.002', 7),
            ('T1204.002', 8),
            ('T1204.002', 9),
            ('T1204.002', 10),
            ('T1047', 1),
            ('T1047', 2),
            ('T1047', 3),
            ('T1047', 4),
            ('T1047', 5),
            ('T1047', 6),
            ('T1047', 7),
            ('T1047', 8),
            ('T1047', 9),
            ('T1047', 10),
            ('T1547', 1),
            ('T1547.001', 1),
            ('T1547.001', 2),
            ('T1547.001', 3),
            ('T1547.001', 4),
            ('T1547.001', 5),
            ('T1547.001', 6),
            ('T1547.001', 7),
            ('T1547.001', 8),
            ('T1547.001', 9),
            ('T1547.004', 1),
            ('T1547.004', 2),
            ('T1547.004', 3),
            ('T1543.003', 1),
            ('T1543.003', 2),
            ('T1543.003', 3),
            ('T1543.003', 4),
            ('T1055', 1),
            ('T1055', 2),
            ('T1055.001', 1),
            ('T1222.001', 1),
            ('T1222.001', 2),
            ('T1222.001', 3),
            ('T1222.001', 4),
            ('T1222.001', 5),
            ('T1562.001', 10),
            ('T1562.001', 11),
            ('T1562.001', 12),
            ('T1562.001', 13),
            ('T1562.001', 14),
            ('T1562.001', 15),
            ('T1562.001', 16),
            ('T1562.001', 17),
            ('T1562.001', 18),
            ('T1562.001', 19),
            ('T1562.001', 20),
            ('T1562.001', 21),
            ('T1562.001', 22),
            ('T1562.001', 23),
            ('T1562.001', 24),
            ('T1562.001', 25),
            ('T1562.001', 26),
            ('T1562.001', 27),
            ('T1562.001', 28),
            ('T1562.001', 29),
            ('T1070', 1),
            ('T1070.004', 4),
            ('T1070.004', 5),
            ('T1070.004', 6),
            ('T1070.004', 7),
            ('T1070.004', 9),
            ('T1070.004', 10),
            ('T1036', 1),
            ('T1036', 2),
            ('T1036.004', 1),
            ('T1036.004', 2),
            ('T1112', 1),
            ('T1112', 2),
            ('T1112', 3),
            ('T1112', 4),
            ('T1112', 5),
            ('T1112', 6),
            ('T1112', 7),
            ('T1112', 8),
            ('T1112', 9),
            ('T1112', 10),
            ('T1112', 11),
            ('T1112', 12),
            ('T1112', 13),
            ('T1112', 14),
            ('T1112', 15),
            ('T1112', 16),
            ('T1112', 17),
            ('T1112', 18),
            ('T1112', 19),
            ('T1112', 20),
            ('T1112', 21),
            ('T1112', 22),
            ('T1112', 23),
            ('T1112', 24),
            ('T1112', 25),
            ('T1112', 26),
            ('T1112', 27),
            ('T1112', 28),
            ('T1112', 29),
            ('T1112', 30),
            ('T1112', 31),
            ('T1112', 32),
            ('T1112', 33),
            ('T1112', 34),
            ('T1027', 2),
            ('T1027', 3),
            ('T1027', 4),
            ('T1027', 5),
            ('T1027', 6),
            ('T1027', 7),
            ('T1557.001', 1),
            ('T1003', 1),
            ('T1003', 2),
            ('T1003', 3),
            ('T1003.002', 1),
            ('T1003.002', 2),
            ('T1003.002', 3),
            ('T1003.002', 4),
            ('T1003.002', 5),
            ('T1003.002', 6),
            ('T1003.003', 1),
            ('T1003.003', 2),
            ('T1003.003', 3),
            ('T1558.003', 1),
            ('T1558.003', 2),
            ('T1558.003', 3),
            ('T1558.003', 4),
            ('T1558.003', 5),
            ('T1087.002', 1),
            ('T1087.002', 2),
            ('T1087.002', 3),
            ('T1087.002', 4),
            ('T1087.002', 5),
            ('T1087.002', 6),
            ('T1087.002', 7),
            ('T1087.002', 8),
            ('T1087.002', 9),
            ('T1087.002', 10),
            ('T1087.002', 11),
            ('T1087.002', 12),
            ('T1087.002', 13),
            ('T1087.002', 14),
            ('T1087.002', 15),
            ('T1018', 1),
            ('T1018', 2),
            ('T1018', 3),
            ('T1018', 4),
            ('T1018', 5),
            ('T1018', 8),
            ('T1018', 9),
            ('T1018', 10),
            ('T1018', 11),
            ('T1018', 15),
            ('T1018', 16),
            ('T1018', 17),
            ('T1018', 18),
            ('T1018', 19),
            ('T1016', 1),
            ('T1016', 2),
            ('T1016', 4),
            ('T1016', 5),
            ('T1016', 6),
            ('T1016', 7),
            ('T1033', 1),
            ('T1033', 3),
            ('T1033', 4),
            ('T1033', 5),
            ('T1021.001', 1),
            ('T1021.001', 2),
            ('T1021.001', 3),
            ('T1021.001', 4),
            ('T1021.002', 1),
            ('T1021.002', 2),
            ('T1021.002', 3),
            ('T1021.002', 4),
            ('T1021.006', 1),
            ('T1021.006', 2),
            ('T1021.006', 3),
            ('T1071.001', 1),
            ('T1071.001', 2),
            ('T1489', 1),
            ('T1489', 2),
            ('T1489', 3))

$cleanup_dir = "$res_loc\ART_Results\Cleanups"

if (Test-Path $cleanup_dir) {
} else {
  mkdir $cleanup_dir > 1.md; rm 1.md
}
# $cl = "$cleanup_dir\cleanup_Wizard_Spider.txt"

$c = 0
foreach ($tid in $wizard_spider) {
    Write-Output "`n[******** BEGIN TEST-$tid CLEANUP *******]" | Tee-Object -file $cleanup_dir\$date_time.txt -Append | yellow
    powershell.exe Invoke-AtomicTest $wizard_spider[$c][0] -TestNumbers $wizard_spider[$c][1] -Cleanup | Add-Content $cleanup_dir\temp.txt
    cat $cleanup_dir\temp.txt
    cat $cleanup_dir\temp.txt >> $cleanup_dir\$date_time.txt
    rm $cleanup_dir\temp.txt
    Write-Output "[!!!!!!!! END  TEST-$tid CLEANUP !!!!!!!]" | Tee-Object -file $cleanup_dir\$date_time.txt -Append | yellow
}

Write-Output "`n >> Cleanup Logs stored in `"$cleanup_dir\$date_time.txt`" ...`n" | green